/*
 * Intel WebRTC SDK version 4.0.0
 * Copyright (c) 2018 Intel <http://webrtc.intel.com>
 * Homepage: http://webrtc.intel.com
 */



!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).Ics=e()}}(function(){return function e(t,n,i){function r(a,s){if(!n[a]){if(!t[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(o)return o(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var d=n[a]={exports:{}};t[a][0].call(d.exports,function(e){var n=t[a][1][e];return r(n||e)},d,d.exports,e,t,n,i)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<i.length;a++)r(i[a]);return r}({1:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.Base64=function(){var e,t,n,i,r,o,a,s,c,u;for(e=-1,t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"],n=[],o=0;o<t.length;o+=1)n[t[o]]=o;return a=function(e){i=e,r=0},s=function(){var t;return i?r>=i.length?e:(t=255&i.charCodeAt(r),r+=1,t):e},c=function(){if(!i)return e;for(;;){if(r>=i.length)return e;var t=i.charAt(r);if(r+=1,n[t])return n[t];if("A"===t)return 0}},u=function(e){return 1===(e=e.toString(16)).length&&(e="0"+e),e="%"+e,unescape(e)},{encodeBase64:function(n){var i,r,o;for(a(n),i="",r=new Array(3),o=!1;!o&&(r[0]=s())!==e;)r[1]=s(),r[2]=s(),i+=t[r[0]>>2],r[1]!==e?(i+=t[r[0]<<4&48|r[1]>>4],r[2]!==e?(i+=t[r[1]<<2&60|r[2]>>6],i+=t[63&r[2]]):(i+=t[r[1]<<2&60],i+="=",o=!0)):(i+=t[r[0]<<4&48],i+="=",i+="=",o=!0);return i},decodeBase64:function(t){var n,i,r;for(a(t),n="",i=new Array(4),r=!1;!r&&(i[0]=c())!==e&&(i[1]=c())!==e;)i[2]=c(),i[3]=c(),n+=u(i[0]<<2&255|i[1]>>4),i[2]!==e?(n+=u(i[1]<<4&255|i[2]>>2),i[3]!==e?n+=u(i[2]<<6&255|i[3]):r=!0):r=!0;return n}}}()},{}],2:[function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});n.AudioCodec={PCMU:"pcmu",PCMA:"pcma",OPUS:"opus",G722:"g722",ISAC:"iSAC",ILBC:"iLBC",AAC:"aac",AC3:"ac3",NELLYMOSER:"nellymoser"},n.AudioCodecParameters=function e(t,n,r){i(this,e),this.name=t,this.channelCount=n,this.clockRate=r},n.AudioEncodingParameters=function e(t,n){i(this,e),this.codec=t,this.maxBitrate=n},n.VideoCodec={VP8:"vp8",VP9:"vp9",H264:"h264",H265:"h265"},n.VideoCodecParameters=function e(t,n){i(this,e),this.name=t,this.profile=n},n.VideoEncodingParameters=function e(t,n){i(this,e),this.codec=t,this.maxBitrate=n}},{}],3:[function(e,t,n){"use strict";function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});n.EventDispatcher=function(){var e={dispatcher:{}};e.dispatcher.eventListeners={},this.addEventListener=function(t,n){void 0===e.dispatcher.eventListeners[t]&&(e.dispatcher.eventListeners[t]=[]),e.dispatcher.eventListeners[t].push(n)},this.removeEventListener=function(t,n){if(e.dispatcher.eventListeners[t]){var i=e.dispatcher.eventListeners[t].indexOf(n);-1!==i&&e.dispatcher.eventListeners[t].splice(i,1)}},this.clearEventListener=function(t){e.dispatcher.eventListeners[t]=[]},this.dispatchEvent=function(t){e.dispatcher.eventListeners[t.type]&&e.dispatcher.eventListeners[t.type].map(function(e){e(t)})}};var a=n.IcsEvent=function e(t){o(this,e),this.type=t};n.MessageEvent=function(e){function t(e,n){o(this,t);var r=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r.origin=n.origin,r.message=n.message,r}return r(t,a),t}(),n.ErrorEvent=function(e){function t(e,n){o(this,t);var r=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r.error=n.error,r}return r(t,a),t}(),n.MuteEvent=function(e){function t(e,n){o(this,t);var r=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r.kind=n.kind,r}return r(t,a),t}()},{}],4:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("./mediastream-factory.js");Object.keys(i).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return i[e]}})});var r=e("./stream.js");Object.keys(r).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return r[e]}})});var o=e("./mediaformat.js");Object.keys(o).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(n,e,{enumerable:!0,get:function(){return o[e]}})})},{"./mediaformat.js":6,"./mediastream-factory.js":7,"./stream.js":10}],5:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=function(){var e=function(){},t={DEBUG:0,TRACE:1,INFO:2,WARNING:3,ERROR:4,NONE:5};t.log=window.console.log.bind(window.console);var n=function(e){return"function"==typeof window.console[e]?window.console[e].bind(window.console):window.console.log.bind(window.console)},i=function(i){t.debug=i<=0?n("log"):e,t.trace=i<=1?n("trace"):e,t.info=i<=2?n("info"):e,t.warning=i<=3?n("warn"):e,t.error=i<=4?n("error"):e};return i(0),t.setLogLevel=i,t}();n.default=i},{}],6:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.AudioSourceInfo={MIC:"mic",SCREENCAST:"screen-cast",FILE:"file",MIXED:"mixed"},n.VideoSourceInfo={CAMERA:"camera",SCREENCAST:"screen-cast",FILE:"file",MIXED:"mixed"},n.TrackKind={AUDIO:"audio",VIDEO:"video",AUDIO_AND_VIDEO:"av"},n.Resolution=function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.width=t,this.height=n}},{}],7:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.MediaStreamFactory=n.StreamConstraints=n.VideoTrackConstraints=n.AudioTrackConstraints=void 0;var i,r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=d(e("./utils.js")),s=e("./logger.js"),c=(i=s)&&i.__esModule?i:{default:i},u=d(e("./mediaformat.js"));function d(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}n.AudioTrackConstraints=function e(t){if(l(this,e),!Object.values(u.AudioSourceInfo).some(function(e){return e===t}))throw new TypeError("Invalid source.");this.source=t},n.VideoTrackConstraints=function e(t){if(l(this,e),!Object.values(u.VideoSourceInfo).some(function(e){return e===t}))throw new TypeError("Invalid source.");this.source=t},n.StreamConstraints=function e(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];l(this,e),this.audio=t,this.video=n};function f(e){return"object"===o(e.audio)&&e.audio.source===u.AudioSourceInfo.SCREENCAST||"object"===o(e.video)&&e.video.source===u.VideoSourceInfo.SCREENCAST}n.MediaStreamFactory=function(){function e(){l(this,e)}return r(e,null,[{key:"createMediaStream",value:function(e){if("object"!==(void 0===e?"undefined":o(e))||!e.audio&&!e.video)return Promise.reject(new TypeError("Invalid constrains"));if(f(e)&&!a.isChrome()&&!a.isFirefox())return Promise.reject(new TypeError("Screen sharing only supports Chrome and Firefox."));if(f(e)&&a.isChrome()){if(!e.extensionId)return Promise.reject(new TypeError("Extension ID must be specified for screen sharing on Chrome."));var t=["screen","window","tab"];return e.audio&&t.push("audio"),new Promise(function(n,i){chrome.runtime.sendMessage(e.extensionId,{getStream:t},function(t){if(void 0===t)return i(new Error(chrome.runtime.lastError.message));e.audio&&"object"!==o(t.options)&&c.default.warning("Desktop sharing with audio requires the latest Chrome extension. Your audio constraints will be ignored.");var r=Object.create({});e.audio&&"object"===o(t.options)&&(t.options.canRequestAudioTrack?r.audio={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t.streamId}}:c.default.warning("Sharing screen with audio was not selected by user.")),r.video=Object.create({}),r.video.mandatory=Object.create({}),r.video.mandatory.chromeMediaSource="desktop",r.video.mandatory.chromeMediaSourceId=t.streamId,e.video.resolution&&(r.video.mandatory.maxHeight=r.video.mandatory.minHeight=e.video.resolution.height,r.video.mandatory.maxWidth=r.video.mandatory.minWidth=e.video.resolution.width),e.video.frameRate&&(r.video.mandatory.minFrameRate=e.video.frameRate,r.video.mandatory.maxFrameRate=e.video.frameRate),n(navigator.mediaDevices.getUserMedia(r))})})}if(!e.audio&&!e.video)return Promise.reject(new TypeError("At least one of audio and video must be requested."));var n=Object.create({});return"object"===o(e.audio)&&e.audio.source===u.AudioSourceInfo.MIC?(n.audio=Object.create({}),n.audio.deviceId=e.audio.deviceId):n.audio=e.audio,"object"===o(e.audio)&&e.audio.source===u.AudioSourceInfo.SCREENCAST&&(c.default.warning("Screen sharing with audio is not supported in Firefox."),n.audio=!1),"object"===o(e.video)?(n.video=Object.create({}),"number"==typeof e.video.frameRate&&(n.video.frameRate=e.video.frameRate),e.video.resolution&&e.video.resolution.width&&e.video.resolution.height&&(n.video.width=e.video.resolution.width,n.video.height=e.video.resolution.height),e.video.deviceId instanceof String&&(n.video.deviceId=e.video.deviceId),a.isFirefox()&&e.video.source===u.VideoSourceInfo.SCREENCAST&&(n.video.mediaSource="screen")):n.video=e.video,navigator.mediaDevices.getUserMedia(n)}}]),e}()},{"./logger.js":5,"./mediaformat.js":6,"./utils.js":11}],8:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.Publication=n.PublicationSettings=n.VideoPublicationSettings=n.AudioPublicationSettings=void 0;var i=o(e("./utils.js")),r=(o(e("./mediaformat.js")),e("../base/event.js"));function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}n.AudioPublicationSettings=function e(t){a(this,e),this.codec=t},n.VideoPublicationSettings=function e(t,n,i,r,o){a(this,e),this.codec=t,this.resolution=n,this.frameRate=i,this.bitrate=r,this.keyFrameInterval=o},n.PublicationSettings=function e(t,n){a(this,e),this.audio=t,this.video=n},n.Publication=function(e){function t(e,n,r,o,s){a(this,t);var c=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return Object.defineProperty(c,"id",{configurable:!1,writable:!1,value:e||i.createUuid()}),c.stop=n,c.getStats=r,c.mute=o,c.unmute=s,c}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,r.EventDispatcher),t}()},{"../base/event.js":3,"./mediaformat.js":6,"./utils.js":11}],9:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.reorderCodecs=function(e,t,n){if(!n||0===n.length)return e;n="audio"===t?n.concat(u):n.concat(d);var i=e.split("\r\n"),r=a(i,"m=",t);if(null===r)return e;var f=i[r].split(" ");f.splice(0,3);var p=[],h=!0,v=!1,_=void 0;try{for(var m,g=n[Symbol.iterator]();!(h=(m=g.next()).done);h=!0)for(var b=m.value,y=0;y<i.length;y++){var S=s(i,y,-1,"a=rtpmap",b);if(null!==S){var P=c(i[S]);P&&(p.push(P),y=S)}}}catch(e){v=!0,_=e}finally{try{!h&&g.return&&g.return()}finally{if(v)throw _}}p=function(e,t){var n=!0,i=!1,r=void 0;try{for(var s,c=t[Symbol.iterator]();!(n=(s=c.next()).done);n=!0){var u=s.value,d=a(e,"a=fmtp","apt="+u);if(null!==d){var l=o(e[d]);t.push(l.pt)}}}catch(e){i=!0,r=e}finally{try{!n&&c.return&&c.return()}finally{if(i)throw r}}return t}(i,p),i[r]=(w=i[r],E=p,C=w.split(" ").slice(0,3),(C=C.concat(E)).join(" "));var w,E,C;var O=!0,j=!1,I=void 0;try{for(var T,N=f[Symbol.iterator]();!(O=(T=N.next()).done);O=!0){var k=T.value;-1===p.indexOf(k)&&(i=l(i,k))}}catch(e){j=!0,I=e}finally{try{!O&&N.return&&N.return()}finally{if(j)throw I}}return e=i.join("\r\n")};var i,r=e("./logger.js");(i=r)&&i.__esModule;function o(e){var t={},n=e.indexOf(" "),i=e.substring(n+1).split(";"),r=new RegExp("a=fmtp:(\\d+)"),o=e.match(r);if(!o||2!==o.length)return null;t.pt=o[1];for(var a={},s=0;s<i.length;++s){var c=i[s].split("=");2===c.length&&(a[c[0]]=c[1])}return t.params=a,t}function a(e,t,n){return s(e,0,-1,t,n)}function s(e,t,n,i,r){for(var o=-1!==n?n:e.length,a=t;a<o;++a)if(0===e[a].indexOf(i)&&(!r||-1!==e[a].toLowerCase().indexOf(r.toLowerCase())))return a;return null}function c(e){var t=new RegExp("a=rtpmap:(\\d+) [a-zA-Z0-9-]+\\/\\d+"),n=e.match(t);return n&&2===n.length?n[1]:null}var u=["CN","telephone-event"],d=["red","ulpfec"];function l(e,t){for(var n=new RegExp("a=(rtpmap|rtcp-fb|fmtp):"+t+"\\s"),i=e.length-1;i>0;i--)e[i].match(n)&&e.splice(i,1);return e}},{"./logger.js":5}],10:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.StreamEvent=n.RemoteStream=n.LocalStream=n.Stream=n.StreamSourceInfo=void 0;var i,r=e("./logger.js"),o=((i=r)&&i.__esModule,e("./event.js")),a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(e("./utils.js"));function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function c(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function d(e,t){return t.some(function(t){return t===e})}var l=n.StreamSourceInfo=function e(t,n){if(u(this,e),!d(t,[void 0,"mic","screen-cast","file","mixed"]))throw new TypeError("Incorrect value for audioSourceInfo");if(!d(n,[void 0,"camera","screen-cast","file","mixed"]))throw new TypeError("Incorrect value for videoSourceInfo");this.audio=t,this.video=n},f=n.Stream=function(e){function t(e,n){u(this,t);var i=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));if(e&&!(e instanceof MediaStream)||!(n instanceof l))throw new TypeError("Invalid stream or sourceInfo.");if(e&&(e.getAudioTracks().length>0&&!n.audio||e.getVideoTracks().length>0&&!n.video))throw new TypeError("Missing audio source info or video source info.");return Object.defineProperty(i,"mediaStream",{configurable:!1,writable:!0,value:e}),Object.defineProperty(i,"source",{configurable:!1,writable:!1,value:n}),i}return c(t,o.EventDispatcher),t}();n.LocalStream=function(e){function t(e,n){if(u(this,t),!(e instanceof MediaStream))throw new TypeError("Invalid stream.");var i=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n));return Object.defineProperty(i,"id",{configurable:!1,writable:!1,value:a.createUuid()}),i}return c(t,f),t}(),n.RemoteStream=function(e){function t(e,n,i,r){u(this,t);var o=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i,r));return Object.defineProperty(o,"id",{configurable:!1,writable:!1,value:e||a.createUuid()}),Object.defineProperty(o,"origin",{configurable:!1,writable:!1,value:n}),o}return c(t,f),t}(),n.StreamEvent=function(e){function t(e,n){u(this,t);var i=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.stream=n.stream,i}return c(t,o.IcsEvent),t}()},{"./event.js":3,"./logger.js":5,"./utils.js":11}],11:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.isFirefox=function(){return null!==window.navigator.userAgent.match("Firefox")},n.isChrome=function(){return null!==window.navigator.userAgent.match("Chrome")},n.createUuid=function(){return"xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"===e?t:3&t|8;return n.toString(16)})},n.sysInfo=function(){var e=Object.create({});e.sdk={version:i,type:"JavaScript"};var t=navigator.userAgent,n=/Chrome\/([0-9\.]+)/.exec(t);n?e.runtime={name:"Chrome",version:n[1]}:(n=/Firefox\/([0-9\.]+)/.exec(t))?e.runtime={name:"Firefox",version:n[1]}:(n=/Edge\/([0-9\.]+)/.exec(t))?e.runtime={name:"Edge",version:n[1]}:e.runtime={name:"Unknown",version:"Unknown"};(n=/Windows NT ([0-9\.]+)/.exec(t))?e.os={name:"Windows NT",version:n[1]}:(n=/Intel Mac OS X ([0-9_\.]+)/.exec(t))?e.os={name:"Mac OS X",version:n[1].replace(/_/g,".")}:(n=/iPhone OS ([0-9_\.]+)/.exec(t))?e.os={name:"iPhone OS",version:n[1].replace(/_/g,".")}:(n=/X11; Linux/.exec(t))?e.os={name:"Linux",version:"Unknown"}:(n=/Android( ([0-9\.]+))?/.exec(t))?e.os={name:"Android",version:n[1]||"Unknown"}:(n=/CrOS/.exec(t))?e.os={name:"Chrome OS",version:"Unknown"}:e.os={name:"Unknown",version:"Unknown"};return e};var i="4.0"},{}],12:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ConferencePeerConnectionChannel=void 0;var i,r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),o=e("../base/logger.js"),a=(i=o)&&i.__esModule?i:{default:i},s=e("../base/event.js"),c=e("../base/mediaformat.js"),u=e("../base/publication.js"),d=e("./subscription.js"),l=e("./error.js"),f=(p(l),p(e("../base/utils.js")),p(e("../base/stream.js")),p(e("../base/sdputils.js")));function p(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}n.ConferencePeerConnectionChannel=function(e){function t(e,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var i=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i._config=e,i._signaling=n,i._pc=null,i._internalId=null,i._pendingCandidates=[],i._subscribePromise=null,i._publishPromise=null,i._subscribedStream=null,i._publishedStream=null,i._publication=null,i._subscription=null,i._disconnectTimer=null,i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,s.EventDispatcher),r(t,[{key:"onMessage",value:function(e,t){switch(e){case"progress":"soac"===t.status?this._sdpHandler(t.data):"ready"===t.status?this._readyHandler():"error"===t.status&&this._errorHandler(t.data);break;case"stream":this._onStreamEvent(t);break;default:a.default.warning("Unknown notification from MCU.")}}},{key:"publish",value:function(e,t){var n=this,i={};if(e.mediaStream.getAudioTracks().length>0?(e.mediaStream.getAudioTracks().length>1&&a.default.warning("Publishing a stream with multiple audio tracks is not fully supported."),i.audio={},i.audio.source=e.source.audio):i.audio=!1,e.mediaStream.getVideoTracks().length>0){e.mediaStream.getVideoTracks().length>1&&a.default.warning("Publishing a stream with multiple video tracks is not fully supported."),i.video={},i.video.source=e.source.video;var r=e.mediaStream.getVideoTracks()[0].getSettings();i.video.parameters={resolution:{width:r.width,height:r.height},framerate:r.frameRate}}else i.video=!1;return this._publishedStream=e,this._signaling.sendSignalingMessage("publish",{media:i,attributes:e.attributes}).then(function(r){var o=new s.MessageEvent("id",{message:r.id,origin:n._remoteId});n.dispatchEvent(o),n._internalId=r.id,n._createPeerConnection(),n._pc.addStream(e.mediaStream);if("function"==typeof n._pc.addTransceiver){if(i.audio)n._pc.addTransceiver("audio",{direction:"sendonly"});if(i.video)n._pc.addTransceiver("video",{direction:"sendonly"})}n._pc.createOffer({offerToReceiveAudio:!1,offerToReceiveVideo:!1}).then(function(e){t&&(e.sdp=n._setRtpReceiverOptions(e.sdp,t)),n._pc.setLocalDescription(e).then(function(){n._signaling.sendSignalingMessage("soac",{id:n._internalId,signaling:e})},function(e){a.default.error("Set local description failed. Message: "+JSON.stringify(e))})},function(e){a.default.error("Create offer failed. Error info: "+JSON.stringify(e))})}),new Promise(function(e,t){n._publishPromise={resolve:e,reject:t}})}},{key:"subscribe",value:function(e,t){var n=this,i={};return t.audio?(i.audio={},i.audio.from=e.id):i.audio=!1,t.video?(i.video={},i.video.from=e.id,(t.video.resolution||t.video.frameRate||t.video.bitrateMultiplier&&1!==t.video.bitrateMultiplier||t.video.keyFrameInterval)&&(i.video.parameters={resolution:t.video.resolution,framerate:t.video.frameRate,bitrate:t.video.bitrateMultiplier?"x"+t.video.bitrateMultiplier.toString():void 0,keyFrameInterval:t.video.keyFrameInterval})):i.video=!1,this._subscribedStream=e,this._signaling.sendSignalingMessage("subscribe",{media:i}).then(function(e){var r=new s.MessageEvent("id",{message:e.id,origin:n._remoteId});n.dispatchEvent(r),n._internalId=e.id,n._createPeerConnection();var o={offerToReceiveAudio:!!t.audio,offerToReceiveVideo:!!t.video};if("function"==typeof n._pc.addTransceiver){if(i.audio)n._pc.addTransceiver("audio",{direction:"recvonly"});if(i.video)n._pc.addTransceiver("video",{direction:"recvonly"})}n._pc.createOffer(o).then(function(e){t&&(e.sdp=n._setRtpReceiverOptions(e.sdp,t)),n._pc.setLocalDescription(e).then(function(){n._signaling.sendSignalingMessage("soac",{id:n._internalId,signaling:e})},function(e){a.default.error("Set local description failed. Message: "+JSON.stringify(e))})},function(e){a.default.error("Create offer failed. Error info: "+JSON.stringify(e))})}),new Promise(function(e,t){n._subscribePromise={resolve:e,reject:t}})}},{key:"_unpublish",value:function(){this._signaling.sendSignalingMessage("unpublish",{id:this._internalId}).catch(function(e){a.default.warning("MCU returns negative ack for unpublishing, "+e)}),"closed"!==this._pc.signalingState&&this._pc.close()}},{key:"_unsubscribe",value:function(){this._signaling.sendSignalingMessage("unsubscribe",{id:this._internalId}).catch(function(e){a.default.warning("MCU returns negative ack for unsubscribing, +e")}),"closed"!==this._pc.signalingState&&this._pc.close()}},{key:"_muteOrUnmute",value:function(e,t,n){var i=t?"stream-control":"subscription-control",r=e?"pause":"play";return this._signaling.sendSignalingMessage(i,{id:this._internalId,operation:r,data:n})}},{key:"_onRemoteStreamAdded",value:function(e){a.default.debug("Remote stream added."),this._subscribedStream?this._subscribedStream.mediaStream=e.stream:a.default.warning("Received remote stream without subscription.")}},{key:"_onLocalIceCandidate",value:function(e){e.candidate?"stable"!==this._pc.signalingState?this._pendingCandidates.push(e.candidate):this._sendCandidate(e.candidate):a.default.debug("Empty candidate.")}},{key:"_fireEndedEventOnPublicationOrSubscription",value:function(){var e=new s.IcsEvent("ended");this._publication?(this._publication.dispatchEvent(e),this._publication.stop()):this._subscription&&(this._subscription.dispatchEvent(e),this._subscription.stop())}},{key:"_onIceConnectionStateChange",value:function(e){if(a.default.debug("ICE connection state changed to "+e.currentTarget.iceConnectionState),"closed"===e.currentTarget.iceConnectionState||"failed"===e.currentTarget.iceConnectionState){var t=new l.ConferenceError("ICE connection failed or closed.");this._publishPromise?this._publishPromise.reject(t):this._subscribePromise&&this._subscribePromise.reject(t),this._fireEndedEventOnPublicationOrSubscription()}}},{key:"_sendCandidate",value:function(e){this._signaling.sendSignalingMessage("soac",{id:this._internalId,signaling:{type:"candidate",candidate:{candidate:"a="+e.candidate,sdpMid:e.sdpMid,sdpMLineIndex:e.sdpMLineIndex}}})}},{key:"_createPeerConnection",value:function(){var e=this;this._pc=new RTCPeerConnection(this._config.rtcConfiguration),this._pc.onicecandidate=function(t){e._onLocalIceCandidate.apply(e,[t])},this._pc.onaddstream=function(t){e._onRemoteStreamAdded.apply(e,[t])},this._pc.oniceconnectionstatechange=function(t){e._onIceConnectionStateChange.apply(e,[t])}}},{key:"_getStats",value:function(){return this._pc?this._pc.getStats():Promise.reject(new l.ConferenceError("PeerConnection is not available."))}},{key:"_readyHandler",value:function(){var e=this;this._subscribePromise?(this._subscription=new d.Subscription(this._internalId,function(){return e._unsubscribe(),Promise.resolve()},function(){return e._getStats()},function(t){return e._muteOrUnmute(!0,!1,t)},function(t){return e._muteOrUnmute(!1,!1,t)}),this._subscribedStream.addEventListener("ended",function(){e._subscription.dispatchEvent("ended",new s.IcsEvent("ended"))}),this._subscribePromise.resolve(this._subscription)):this._publishPromise&&(this._publication=new u.Publication(this._internalId,function(){return e._unpublish(),Promise.resolve()},function(){return e._getStats()},function(t){return e._muteOrUnmute(!0,!0,t)},function(t){return e._muteOrUnmute(!1,!0,t)}),this._publishPromise.resolve(this._publication)),this._publishPromise=null,this._subscribePromise=null}},{key:"_sdpHandler",value:function(e){var t=this;"answer"===e.type&&this._pc.setRemoteDescription(e).then(function(){if(t._pendingCandidates.length>0){var e=!0,n=!1,i=void 0;try{for(var r,o=t._pendingCandidates[Symbol.iterator]();!(e=(r=o.next()).done);e=!0){var a=r.value;t._sendCandidate(a)}}catch(e){n=!0,i=e}finally{try{!e&&o.return&&o.return()}finally{if(n)throw i}}}},function(e){a.default.error("Set remote description failed: "+e)})}},{key:"_errorHandler",value:function(e){var t=this._publication||this._subscription;t||a.default.warning("Neither publication nor subscription is available.");var n=new l.ConferenceError(e),i=new s.ErrorEvent("error",{error:n});t.dispatchEvent(i)}},{key:"_setCodecOrder",value:function(e,t){if(this._publication||this._publishPromise){if(t.audio){var n=Array.from(t.audio,function(e){return e.codec.name});e=f.reorderCodecs(e,"audio",n)}if(t.video){var i=Array.from(t.video,function(e){return e.codec.name});e=f.reorderCodecs(e,"video",i)}}else{if(t.audio&&t.audio.codecs){var r=Array.from(t.audio.codecs,function(e){return e.name});e=f.reorderCodecs(e,"audio",r)}if(t.video&&t.video.codecs){var o=Array.from(t.video.codecs,function(e){return e.name});e=f.reorderCodecs(e,"video",o)}}return e}},{key:"_setRtpSenderOptions",value:function(e,t){return e}},{key:"_setRtpReceiverOptions",value:function(e,t){return e=this._setCodecOrder(e,t)}},{key:"_onStreamEvent",value:function(e){var t=void 0;if(this._publishedStream&&e.id===this._publishedStream.id?t=this._publication:this._subscribedStream&&e.id===this._subscribedStream.id&&(t=this._subscription),t){var n=void 0;"audio.status"===e.data.field?n=c.TrackKind.AUDIO:"video.status"===e.data.field?n=c.TrackKind.VIDEO:a.default.warning("Invalid data field for stream update info."),"active"===e.data.value?t.dispatchEvent(new s.MuteEvent("unmute",{kind:n})):"inactive"===e.data.value?t.dispatchEvent(new s.MuteEvent("mute",{kind:n})):a.default.warning("Invalid data value for stream update info.")}else a.default.warning("Cannot find valid event target.")}}]),t}()},{"../base/event.js":3,"../base/logger.js":5,"../base/mediaformat.js":6,"../base/publication.js":8,"../base/sdputils.js":9,"../base/stream.js":10,"../base/utils.js":11,"./error.js":14,"./subscription.js":21}],13:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.ConferenceClient=void 0;var i,r=m(e("../base/event.js")),o=e("./signaling.js"),a=e("../base/logger.js"),s=(i=a)&&i.__esModule?i:{default:i},c=e("../base/base64.js"),u=e("./error.js"),d=m(e("../base/utils.js")),l=m(e("../base/stream.js")),f=e("./participant.js"),p=e("./info.js"),h=e("./channel.js"),v=e("./mixedstream.js"),_=m(e("./streamutils.js"));function m(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}var g=1,b=2,y=3,S=function(e,t){var n=new r.IcsEvent(e,t);return n.participant=t.participant,n};(n.ConferenceClient=function(e,t){e=e||{};var n=this,i=g,a=t||new o.SioSignaling,m=void 0,P=void 0,w=new Map,E=new Map,C=new Map,O=new Map;function j(e,t){if("soac"===e||"progress"===e){if(!O.has(t.id))return void s.default.warning("Cannot find a channel for incoming data.");O.get(t.id).onMessage(e,t)}else"stream"===e?"add"===t.status?function(e){var t=I(e);w.set(t.id,t);var i=new l.StreamEvent("streamadded",{stream:t});n.dispatchEvent(i)}(t.data):"remove"===t.status?function(e){if(!w.has(e.id))return void s.default.warning("Cannot find specific remote stream.");var t=w.get(e.id),n=new r.IcsEvent("ended");w.delete(t.id),t.dispatchEvent(n)}(t):"update"===t.status&&("audio.status"!==t.data.field&&"video.status"!==t.data.field||O.forEach(function(n){n.onMessage(e,t)})):"text"===e?(i=t,o=new r.MessageEvent("messagereceived",{message:i.message,origin:i.from}),n.dispatchEvent(o)):"participant"===e&&function(e){if("join"===e.action){e=e.data;var t=new f.Participant(e.id,e.role,e.user);E.set(e.id,t);var i=new S("participantjoined",{participant:t});n.dispatchEvent(i)}else if("leave"===e.action){var o=e.data;if(!E.has(o))return void s.default.warning("Received leave message from MCU for an unknown participant.");var a=E.get(o);E.delete(o),a.dispatchEvent(new r.IcsEvent("left"))}}(t);var i,o}function I(e){if("mixed"===e.type)return new v.RemoteMixedStream(e);var t=void 0,n=void 0;e.media.audio&&(t=e.media.audio.source),e.media.video&&(n=e.media.video.source);var i=new l.RemoteStream(e.id,e.info.owner,void 0,new l.StreamSourceInfo(t,n));return i.settings=_.convertToPublicationSettings(e.media),i.capabilities=new _.convertToSubscriptionCapabilities(e.media),i}function T(e,t){return a.send(e,t)}function N(){var t=Object.create(r.EventDispatcher);t.sendSignalingMessage=T;var n=new h.ConferencePeerConnectionChannel(e,t);return n.addEventListener("id",function(e){O.set(e.message,n)}),n}a.addEventListener("data",function(e){j(e.message.notification,e.message.data)}),a.addEventListener("disconnect",function(){n.dispatchEvent(new r.IcsEvent("serverdisconnected"))}),Object.defineProperty(this,"info",{configurable:!1,get:function(){return P?new p.ConferenceInfo(P.id,Array.from(E,function(e){return e[1]}),Array.from(w,function(e){return e[1]}),m):null}}),this.join=function(e){return new Promise(function(t,n){var r=JSON.parse(c.Base64.decodeBase64(e)),o=!0===r.secure,s=r.host;if("string"==typeof s)if(-1===s.indexOf("http")&&(s=o?"https://"+s:"http://"+s),i===g){i=b;var l={token:e,userAgent:d.sysInfo(),protocol:"1.0"};a.connect(s,o,l).then(function(e){if(i=y,void 0!==(P=e.room).streams){var n=!0,r=!1,o=void 0;try{for(var a,s=P.streams[Symbol.iterator]();!(n=(a=s.next()).done);n=!0){var c=a.value;"mixed"===c.type&&(c.viewport=c.info.label),w.set(c.id,I(c))}}catch(e){r=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw o}}}if(e.room&&void 0!==e.room.participants){var u=!0,d=!1,l=void 0;try{for(var h,v=e.room.participants[Symbol.iterator]();!(u=(h=v.next()).done);u=!0){var _=h.value;E.set(_.id,new f.Participant(_.id,_.role,_.user)),_.id===e.id&&(m=E.get(_.id))}}catch(e){d=!0,l=e}finally{try{!u&&v.return&&v.return()}finally{if(d)throw l}}}t(new p.ConferenceInfo(e.room.id,Array.from(E.values()),Array.from(w.values()),m))},function(e){i=g,n(new u.ConferenceError(e))})}else n(new u.ConferenceError("connection state invalid"));else n(new u.ConferenceError("Invalid host."))})},this.publish=function(e,t){return e instanceof l.LocalStream?C.has(e.mediaStream.id)?Promise.reject(new u.ConferenceError("Cannot publish a published stream.")):N().publish(e,t):Promise.reject(new u.ConferenceError("Invalid stream."))},this.subscribe=function(e,t){return e instanceof l.RemoteStream?N().subscribe(e,t):Promise.reject(new u.ConferenceError("Invalid stream."))},this.send=function(e,t){return void 0===t&&(t="all"),T("text",{to:t,message:e})},this.leave=function(){return a.disconnect().then(function(){E.clear(),w.clear(),i=g})}}).prototype=new r.EventDispatcher},{"../base/base64.js":1,"../base/event.js":3,"../base/logger.js":5,"../base/stream.js":10,"../base/utils.js":11,"./channel.js":12,"./error.js":14,"./info.js":16,"./mixedstream.js":17,"./participant.js":18,"./signaling.js":19,"./streamutils.js":20}],14:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.ConferenceError=function(e){function t(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,Error),t}()},{}],15:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("./client.js");Object.defineProperty(n,"ConferenceClient",{enumerable:!0,get:function(){return i.ConferenceClient}});var r=e("./signaling.js");Object.defineProperty(n,"SioSignaling",{enumerable:!0,get:function(){return r.SioSignaling}})},{"./client.js":13,"./signaling.js":19}],16:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});n.ConferenceInfo=function e(t,n,i,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.id=t,this.participants=n,this.remoteStreams=i,this.self=r}},{}],17:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.RemoteMixedStream=void 0;var i=o(e("../base/stream.js")),r=o(e("./streamutils.js"));function o(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}n.RemoteMixedStream=function(e){function t(e){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),"mixed"!==e.type)throw new TypeError("Not a mixed stream");var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e.id,void 0,void 0,new i.StreamSourceInfo("mixed","mixed")));return n.settings=r.convertToPublicationSettings(e.media),n.capabilities=new r.convertToSubscriptionCapabilities(e.media),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,i.RemoteStream),t}()},{"../base/stream.js":10,"./streamutils.js":20}],18:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.Participant=void 0;var i=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(e("../base/event.js"));n.Participant=function(e){function t(e,n,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return Object.defineProperty(r,"id",{configurable:!1,writable:!1,value:e}),Object.defineProperty(r,"role",{configurable:!1,writable:!1,value:n}),Object.defineProperty(r,"userId",{configurable:!1,writable:!1,value:i}),r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,i.EventDispatcher),t}()},{"../base/event.js":3}],19:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.SioSignaling=void 0;var i,r=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),o=e("../base/logger.js"),a=(i=o)&&i.__esModule?i:{default:i},s=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(e("../base/event.js"));function c(e,t,n,i){"ok"===e||"success"===e?n(t):"error"===e?i(t):a.default.error("MCU returns unknown ack.")}n.SioSignaling=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n._socket=null,n._sioConfig=e||{},n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,s.EventDispatcher),r(t,[{key:"connect",value:function(e,t,n){var i=this;return this._sioConfig.secure=t,void 0===this._sioConfig["force new connection"]&&(this._sioConfig["force new connection"]=!0),new Promise(function(t,r){i._socket=io.connect(e,i._sioConfig),["drop","participant","text","stream","progress"].forEach(function(e){i._socket.on(e,function(t){i.dispatchEvent(new s.MessageEvent("data",{message:{notification:e,data:t}}))})}),i._socket.on("disconnect",function(){i.dispatchEvent(new s.IcsEvent("disconnect"))}),i._socket.emit("login",n,function(e,n){c(e,n,t,r)})})}},{key:"disconnect",value:function(){var e=this;return new Promise(function(t,n){e._socket.emit("logout",function(i,r){e._socket.disconnect(),c(i,r,t,n)})})}},{key:"send",value:function(e,t){var n=this;return new Promise(function(i,r){n._socket.emit(e,t,function(e,t){c(e,t,i,r)})})}}]),t}()},{"../base/event.js":3,"../base/logger.js":5}],20:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.convertToPublicationSettings=function(e){var t=void 0,n=void 0,a=void 0,s=void 0,c=void 0,u=void 0,d=void 0,l=void 0;e.audio&&(e.audio.format&&(n=new o.AudioCodecParameters(e.audio.format.codec,e.audio.format.channelNum,e.audio.format.sampleRate)),t=new i.AudioPublicationSettings(n));e.video&&(e.video.format&&(s=new o.VideoCodecParameters(e.video.format.codec,e.video.format.profile)),e.video.parameters&&(c=new r.Resolution(e.video.parameters.resolution.width,e.video.parameters.resolution.height),u=e.video.parameters.framerate,d=1e3*e.video.parameters.bitrate,l=e.video.parameters.keyFrameInterval),a=new i.VideoPublicationSettings(s,c,u,d,l));return new i.PublicationSettings(t,a)},n.convertToSubscriptionCapabilities=function(e){var t=[];e.audio&&e.audio.format&&t.push(new o.AudioCodecParameters(e.audio.format.codec,e.audio.format.channelNum,e.audio.format.sampleRate));if(e.audio&&e.audio.optional&&e.audio.optional.format){var n=!0,i=!1,s=void 0;try{for(var d,l=e.audio.optional.format[Symbol.iterator]();!(n=(d=l.next()).done);n=!0){var f=d.value,p=new o.AudioCodecParameters(f.codec,f.channelNum,f.sampleRate);t.push(p)}}catch(e){i=!0,s=e}finally{try{!n&&l.return&&l.return()}finally{if(i)throw s}}}t.sort();var h=new a.AudioSubscriptionCapabilities(t),v=[];e.video&&e.video.format&&v.push(new o.VideoCodecParameters(e.video.format.codec,e.video.format.profile));if(e.video&&e.video.optional&&e.video.optional.format){var _=!0,m=!1,g=void 0;try{for(var b,y=e.video.optional.format[Symbol.iterator]();!(_=(b=y.next()).done);_=!0){var S=b.value,P=new o.VideoCodecParameters(S.codec,S.profile);v.push(P)}}catch(e){m=!0,g=e}finally{try{!_&&y.return&&y.return()}finally{if(m)throw g}}}v.sort();var w=Array.from(e.video.optional.parameters.resolution,function(e){return new r.Resolution(e.width,e.height)});e.video&&e.video.parameters&&e.video.parameters.resolution&&w.push(new r.Resolution(e.video.parameters.resolution.width,e.video.parameters.resolution.height));w.sort(u);var E=Array.from(e.video.optional.parameters.bitrate,function(e){return function(e){if("string"!=typeof e||!e.startsWith("x"))return L.Logger.warning("Invalid bitrate multiplier input."),0;return Number.parseFloat(e.replace(/^x/,""))}(e)});E.push(1),E.sort(c);var C=JSON.parse(JSON.stringify(e.video.optional.parameters.framerate));e.video&&e.video.parameters&&C.push(e.video.parameters.framerate);C.sort(c);var O=JSON.parse(JSON.stringify(e.video.optional.parameters.keyFrameInterval));e.video&&e.video.parameters&&O.push(e.video.parameters.keyFrameInterval);O.sort(c);var j=new a.VideoSubscriptionCapabilities(v,w,C,E,O);return new a.SubscriptionCapabilities(h,j)};var i=s(e("../base/publication.js")),r=s(e("../base/mediaformat.js")),o=s(e("../base/codec.js")),a=s(e("./subscription.js"));function s(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function c(e,t){return e-t}function u(e,t){return e.width!==t.width?e.width-t.width:e.height-t.height}},{"../base/codec.js":2,"../base/mediaformat.js":6,"../base/publication.js":8,"./subscription.js":21}],21:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.Subscription=n.SubscribeOptions=n.VideoSubscriptionConstraints=n.AudioSubscriptionConstraints=n.SubscriptionCapabilities=n.VideoSubscriptionCapabilities=n.AudioSubscriptionCapabilities=void 0;r(e("../base/mediaformat.js")),r(e("../base/codec.js"));var i=e("../base/event.js");function r(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}n.AudioSubscriptionCapabilities=function e(t){o(this,e),this.codecs=t},n.VideoSubscriptionCapabilities=function e(t,n,i,r,a){o(this,e),this.codecs=t,this.resolutions=n,this.frameRates=i,this.bitrateMultipliers=r,this.keyFrameIntervals=a},n.SubscriptionCapabilities=function e(t,n){o(this,e),this.audio=t,this.video=n},n.AudioSubscriptionConstraints=function e(t){o(this,e),this.codecs=t},n.VideoSubscriptionConstraints=function e(t,n,i,r,a){o(this,e),this.codecs=t,this.resolution=n,this.frameRate=i,this.bitrateMultiplier=r,this.keyFrameInterval=a},n.SubscribeOptions=function e(t,n){o(this,e),this.audio=t,this.video=n},n.Subscription=function(e){function t(e,n,i,r,a){o(this,t);var s=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));if(!e)throw new TypeError("ID cannot be null or undefined.");return Object.defineProperty(s,"id",{configurable:!1,writable:!1,value:e}),s.stop=n,s.getStats=i,s.mute=r,s.unmute=a,s}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,i.EventDispatcher),t}()},{"../base/codec.js":2,"../base/event.js":3,"../base/mediaformat.js":6}],22:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.Conference=n.P2P=n.Base=void 0;var i=a(e("./base/export.js")),r=a(e("./p2p/export.js")),o=a(e("./conference/export.js"));function a(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}n.Base=i,n.P2P=r,n.Conference=o},{"./base/export.js":4,"./conference/export.js":15,"./p2p/export.js":24}],23:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.getErrorByCode=function(e){return{2100:i.P2P_CONN_SERVER_UNKNOWN,2101:i.P2P_CONN_SERVER_UNAVAILABLE,2102:i.P2P_CONN_SERVER_BUSY,2103:i.P2P_CONN_SERVER_NOT_SUPPORTED,2110:i.P2P_CONN_CLIENT_UNKNOWN,2111:i.P2P_CONN_CLIENT_NOT_INITIALIZED,2120:i.P2P_CONN_AUTH_UNKNOWN,2121:i.P2P_CONN_AUTH_FAILED,2201:i.P2P_MESSAGING_TARGET_UNREACHABLE,2400:i.P2P_CLIENT_UNKNOWN,2401:i.P2P_CLIENT_UNSUPPORTED_METHOD,2402:i.P2P_CLIENT_ILLEGAL_ARGUMENT,2403:i.P2P_CLIENT_INVALID_STATE,2404:i.P2P_CLIENT_NOT_ALLOWED,2500:i.P2P_WEBRTC_UNKNOWN}[e]};var i=n.errors={P2P_CONN_SERVER_UNKNOWN:{code:2100,message:"Server unknown error."},P2P_CONN_SERVER_UNAVAILABLE:{code:2101,message:"Server is unavaliable."},P2P_CONN_SERVER_BUSY:{code:2102,message:"Server is too busy."},P2P_CONN_SERVER_NOT_SUPPORTED:{code:2103,message:"Method has not been supported by server."},P2P_CONN_CLIENT_UNKNOWN:{code:2110,message:"Client unknown error."},P2P_CONN_CLIENT_NOT_INITIALIZED:{code:2111,message:"Connection is not initialized."},P2P_CONN_AUTH_UNKNOWN:{code:2120,message:"Authentication unknown error."},P2P_CONN_AUTH_FAILED:{code:2121,message:"Wrong username or token."},P2P_MESSAGING_TARGET_UNREACHABLE:{code:2201,message:"Remote user cannot be reached."},P2P_CLIENT_UNKNOWN:{code:2400,message:"Unknown errors."},P2P_CLIENT_UNSUPPORTED_METHOD:{code:2401,message:"This method is unsupported in current browser."},P2P_CLIENT_ILLEGAL_ARGUMENT:{code:2402,message:"Illegal argument."},P2P_CLIENT_INVALID_STATE:{code:2403,message:"Invalid peer state."},P2P_WEBRTC_UNKNOWN:{code:2500,message:"WebRTC error."}};n.P2PError=function(e){function t(e,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var i=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,n));return i.code=e,i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,Error),t}()},{}],24:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=e("./p2pclient.js");Object.defineProperty(n,"P2PClient",{enumerable:!0,get:function(){return(e=i,e&&e.__esModule?e:{default:e}).default;var e}});var r=e("./error.js");Object.defineProperty(n,"P2PError",{enumerable:!0,get:function(){return r.P2PError}})},{"./error.js":23,"./p2pclient.js":25}],25:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var i=d(e("../base/logger.js")),r=e("../base/event.js"),o=u(e("../base/utils.js")),a=u(e("./error.js")),s=d(e("./peerconnection-channel.js")),c=u(e("../base/stream.js"));function u(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function d(e){return e&&e.__esModule?e:{default:e}}var l=1,f=2,p=3;o.sysInfo(),navigator.mozGetUserMedia,navigator.mozGetUserMedia;var h=function(e,t){var n=e,o=t,u=new Map,d=this,h=l,v=void 0;o.onMessage=function(e,t){i.default.debug("Received signaling message from "+e+": "+t);var n=JSON.parse(t);d.allowedRemoteIds.indexOf(e)>=0?m(e).onMessage(n):"chat-denied"!==n.type&&_(e,"chat-denied")},o.onServerDisconnected=function(){},this.allowedRemoteIds=[],this.connect=function(e){return h!==l?(i.default.warning("Invalid connection state: "+h),Promise.reject(new a.P2PError(a.errors.P2P_CLIENT_INVALID_STATE))):(h=f,new Promise(function(t,n){o.connect(e).then(function(e){h=p,t(v=e)},function(e){n(new a.P2PError(a.getErrorByCode(e)))})}))},this.disconnect=function(){return h==l?Promise.reject(new a.P2PError(a.errors.P2P_CLIENT_INVALID_STATE)):(stop(),o.disconnect())},this.publish=function(e,t){return t instanceof c.LocalStream?this.allowedRemoteIds.indexOf(e)<0?Promise.reject(new a.P2PError(a.errors.P2P_CLIENT_NOT_ALLOWED)):m(e).publish(t):Promise.reject(new TypeError("Invalid stream."))},this.send=function(e,t){return"string"!=typeof t?Promise.reject(new TypeError("Invalid message.")):this.allowedRemoteIds.indexOf(e)<0?Promise.reject(new a.P2PError(a.errors.P2P_CLIENT_NOT_ALLOWED)):m(e).send(t)},this.stop=function(e){if(!u.has(e))return Promise.reject(new a.P2PError(a.errors.P2P_CLIENT_INVALID_STATE,"No PeerConnection between current endpoint and specific remote endpoint."));u.get(e).stop(),u.delete(e)},this.getStats=function(e){return u.has(e)?u.get(e).getStats():Promise.reject(new a.P2PError(a.errors.P2P_CLIENT_INVALID_STATE,"No PeerConnection between current endpoint and specific remote endpoint."))};var _=function(e,t,n){var i={type:t};return n&&(i.data=n),o.send(e,JSON.stringify(i))},m=function(e){if(!u.has(e)){var t=Object.create(r.EventDispatcher);t.sendSignalingMessage=_;var i=new s.default(n,v,e,t);i.addEventListener("streamadded",function(e){d.dispatchEvent(e)}),i.addEventListener("messagereceived",function(e){d.dispatchEvent(e)}),i.addEventListener("p2pclosed",function(){u.delete(e)}),u.set(e,i)}return u.get(e)}};h.prototype=new r.EventDispatcher,n.default=h},{"../base/event.js":3,"../base/logger.js":5,"../base/stream.js":10,"../base/utils.js":11,"./error.js":23,"./peerconnection-channel.js":26}],26:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.P2PPeerConnectionChannelEvent=void 0;var i,r=function(){return function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],i=!0,r=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);i=!0);}catch(e){r=!0,o=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw o}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),o=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),a=e("../base/logger.js"),s=(i=a)&&i.__esModule?i:{default:i},c=e("../base/event.js"),u=e("../base/publication.js"),d=h(e("../base/utils.js")),l=h(e("./error.js")),f=h(e("../base/stream.js")),p=h(e("../base/sdputils.js"));function h(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}function v(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function m(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}n.P2PPeerConnectionChannelEvent=function(e){function t(e){v(this,t);var n=_(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.stream=e.stream,n}return m(t,Event),t}();var g={READY:1,OFFERED:2,PENDING:3,MATCHED:4,CONNECTING:5,CONNECTED:6},b={READY:1,REQUESTED:2,ACCEPTED:3,NEGOTIATING:4},y="message",S="chat-invitation",P="chat-accepted",w="chat-denied",E="chat-closed",C="chat-negotiation-needed",O="chat-track-sources",j="chat-signal",I="chat-tracks-added",T="chat-tracks-removed",N="chat-data-received",k={offerToReceiveAudio:!0,offerToReceiveVideo:!0},M=d.sysInfo(),R=function(e){function t(e,n,i,r){v(this,t);var o=_(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return o._config=e,o._localId=n,o._remoteId=i,o._signaling=r,o._pc=null,o._publishedStreams=new Map,o._pendingStreams=[],o._pendingUnpublishStreams=[],o._remoteStreams=[],o._remoteTrackSourceInfo=new Map,o._publishPromises=new Map,o._unpublishPromises=new Map,o._publishingStreamTracks=new Map,o._publishedStreamTracks=new Map,o._remoteStreamTracks=new Map,o._isCaller=!1,o._negotiationState=b.READY,o._isNegotiationNeeded=!1,o._channelState=g.READY,o._remoteSideSupportsRemoveStream=!0,o._remoteSideSupportsPlanB=!0,o._remoteSideSupportsUnifiedPlan=!0,o._remoteIceCandidates=[],o._dataChannels=new Map,o._pendingMessages=[],o._dataSeq=1,o._sendDataPromises=new Map,o}return m(t,c.EventDispatcher),o(t,[{key:"publish",value:function(e){var t=this;if(this._publishedStreams.has(e))return Promise.reject(new l.P2PError(l.errors.P2P_CLIENT_ILLEGAL_ARGUMENT,"Duplicated stream."));this._channelState===g.READY&&this._invite(),this._pendingStreams.push(e);var n=Array.from(e.mediaStream.getTracks(),function(e){return e.id});return this._publishingStreamTracks.set(e.mediaStream.id,n),new Promise(function(n,i){t._publishPromises.set(e.mediaStream.id,{resolve:n,reject:i}),t._drainPendingStreams()})}},{key:"send",value:function(e){var t=this,n={id:this._dataSeq++,data:e},i=new Promise(function(e,i){t._sendDataPromises.set(n.id,{resolve:e,reject:i})});return this._channelState===g.READY?(this._invite(),this._pendingMessages.push(n),i):(this._dataChannels.has(y)||this._createDataChannel(y),"open"===this._dataChannels.get(y).readyState?this._dataChannels.get(y).send(JSON.stringify(n)):this._pendingMessages.push(n),i)}},{key:"stop",value:function(){var e=!0,t=!1,n=void 0;try{for(var i,o=this._dataChannels[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){var a=i.value,s=r(a,2);s[0];s[1].close()}}catch(e){t=!0,n=e}finally{try{!e&&o.return&&o.return()}finally{if(t)throw n}}this._dataChannels.clear(),this._pc&&"closed"!==this._pc.iceConnectionState&&this._pc.close();var c=!0,u=!1,d=void 0;try{for(var f,p=this._publishPromises[Symbol.iterator]();!(c=(f=p.next()).done);c=!0){var h=f.value,v=r(h,2);v[0];v[1].reject(new l.P2PError(l.errors.P2P_CLIENT_INVALID_STATE,"PeerConnection is closed."))}}catch(e){u=!0,d=e}finally{try{!c&&p.return&&p.return()}finally{if(u)throw d}}this._publishPromises.clear();var _=!0,m=!1,b=void 0;try{for(var y,S=this._unpublishPromises[Symbol.iterator]();!(_=(y=S.next()).done);_=!0){var P=y.value,w=r(P,2);w[0];w[1].reject(new l.P2PError(l.errors.P2P_CLIENT_INVALID_STATE,"PeerConnection is closed."))}}catch(e){m=!0,b=e}finally{try{!_&&S.return&&S.return()}finally{if(m)throw b}}this._unpublishPromises.clear();var E=!0,C=!1,O=void 0;try{for(var j,I=this._sendDataPromises[Symbol.iterator]();!(E=(j=I.next()).done);E=!0){var T=j.value,N=r(T,2);N[0];N[1].reject(new l.P2PError(l.errors.P2P_CLIENT_INVALID_STATE,"PeerConnection is closed."))}}catch(e){C=!0,O=e}finally{try{!E&&I.return&&I.return()}finally{if(C)throw O}}this._state!==g.READY&&(this._state=g.READY,this.dispatchEvent(new Event("p2pclosed")))}},{key:"getStats",value:function(e){return this._pc?this._pc.getStats(e):Promise.reject(new l.P2PError(l.errors.P2P_CLIENT_INVALID_STATE))}},{key:"onMessage",value:function(e){this._SignalingMesssageHandler(e)}},{key:"_sendSdp",value:function(e){this._signaling.sendSignalingMessage(this._remoteId,j,e)}},{key:"_sendSignalingMessage",value:function(e,t){this._signaling.sendSignalingMessage(this._remoteId,e,t)}},{key:"_invite",value:function(){this._channelState===g.READY?(this._channelState=g.OFFERED,this._sendSignalingMessage(E),this._sendSignalingMessage(S,{ua:M})):s.default.debug("Cannot send invitation during this state: "+this._channelState),this._isCaller=!0}},{key:"_accept",value:function(){this._channelState===g.PENDING?(this._sendSignalingMessage(P,{ua:M}),this._channelState=g.MATCHED):s.default.debug("Cannot send acceptance during this state: "+this._channelState)}},{key:"_SignalingMesssageHandler",value:function(e){switch(s.default.debug("Channel received message: "+e),e.type){case S:this._chatInvitationHandler(e.data.ua);break;case w:this._chatDeniedHandler();break;case P:this._chatAcceptedHandler(e.data.ua);break;case C:this._negotiationNeededHandler();break;case O:this._trackSourcesHandler(e.data);break;case j:this._sdpHandler(e.data);break;case I:this._tracksAddedHandler(e.data);break;case T:this._tracksRemovedHandler(e.data);break;case N:this._dataReceivedHandler(e.data);break;case E:this._chatClosedHandler();break;default:s.default.error("Invalid signaling message received. Type: "+e.type)}}},{key:"_tracksAddedHandler",value:function(e){var t=this,n=function(e){t._publishingStreamTracks.forEach(function(n,i){for(var r=0;r<n.length;r++){if(n[r]===e&&(t._publishedStreamTracks.has(i)||t._publishedStreamTracks.set(i,[]),t._publishedStreamTracks.get(i).push(n[r]),n.splice(r,1)),0==n.length)if("continue"===function(){if(!t._publishPromises.has(i))return s.default.warning("Cannot find the promise for publishing "+i),"continue";var n=Array.from(t._publishedStreams,function(e){return e[0]}).find(function(e){return e.mediaStream.id==i}),r=new u.Publication(e,function(){return t._unpublish(n).then(function(){r.dispatchEvent(new c.IcsEvent("ended"))})},function(){return t.getStats(n.mediaStream)});t._publishedStreams.set(n,r),t._publishPromises.get(i).resolve(r),t._publishPromises.delete(i)}())continue}})},i=!0,r=!1,o=void 0;try{for(var a,d=e[Symbol.iterator]();!(i=(a=d.next()).done);i=!0){n(a.value)}}catch(e){r=!0,o=e}finally{try{!i&&d.return&&d.return()}finally{if(r)throw o}}}},{key:"_tracksRemovedHandler",value:function(e){var t=this,n=function(e){t._publishedStreamTracks.forEach(function(n,i){for(var r=0;r<n.length;r++)if(n[r]===e&&n.splice(r,1),0==n.length){if(!t._unpublishPromises.has(i)){s.default.warning("Cannot find the promise for removing "+i);continue}t._unpublishPromises.get(i).resolve(),t._unpublishPromises.delete(i)}})},i=!0,r=!1,o=void 0;try{for(var a,c=e[Symbol.iterator]();!(i=(a=c.next()).done);i=!0){n(a.value)}}catch(e){r=!0,o=e}finally{try{!i&&c.return&&c.return()}finally{if(r)throw o}}}},{key:"_dataReceivedHandler",value:function(e){this._sendDataPromises.has(e)?this._sendDataPromises.get(e).resolve():s.default.warning("Received unknown data received message. ID: "+e)}},{key:"_chatInvitationHandler",value:function(e){s.default.debug("Received chat invitation."),this._channelState=g.PENDING,this._accept()}},{key:"_chatAcceptedHandler",value:function(e){s.default.debug("Received chat accepted."),this._handleRemoteCapability(e),this._channelState=g.CONNECTING,this._createPeerConnection()}},{key:"_negotiationNeededHandler",value:function(){s.default.debug("Remote side needs negotiation."),this._isCaller&&"stable"===this._pc.signalingState&&this._negotiationState===b.READY?this._doNegotiate():(this._isNegotiationNeeded=!0,s.default.warning("Should not receive negotiation needed request because user is callee."))}},{key:"_sdpHandler",value:function(e){"offer"===e.type?this._onOffer(e):"answer"===e.type?this._onAnswer(e):"candidates"===e.type&&this._onRemoteIceCandidate(e)}},{key:"_trackSourcesHandler",value:function(e){var t=!0,n=!1,i=void 0;try{for(var r,o=e[Symbol.iterator]();!(t=(r=o.next()).done);t=!0){var a=r.value;this._remoteTrackSourceInfo.set(a.id,a.source)}}catch(e){n=!0,i=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw i}}}},{key:"_chatClosedHandler",value:function(){this.stop()}},{key:"_chatDeniedHandler",value:function(){this.stop()}},{key:"_onOffer",value:function(e){var t=this;switch(this._channelState){case g.OFFERED:case g.MATCHED:this._channelState=g.CONNECTING,this._createPeerConnection();case g.CONNECTING:case g.CONNECTED:s.default.debug("About to set remote description. Signaling state: "+this._pc.signalingState);var n=new RTCSessionDescription(e);this._pc.setRemoteDescription(n).then(function(){t._createAndSendAnswer()},function(e){s.default.debug("Set remote description failed. Message: "+JSON.stringify(e))});break;default:s.default.debug("Unexpected peer state: "+this._channelState)}}},{key:"_onAnswer",value:function(e){var t=this;if(this._channelState===g.CONNECTING||this._channelState===g.CONNECTED){s.default.debug("About to set remote description. Signaling state: "+this._pc.signalingState);var n=new RTCSessionDescription(e);this._pc.setRemoteDescription(new RTCSessionDescription(n)).then(function(){s.default.debug("Set remote descripiton successfully."),t._drainPendingMessages()},function(e){s.default.debug("Set remote description failed. Message: "+e)})}else s.default.warning("Received answer at invalid state. Current state: "+this._channelState)}},{key:"_onLocalIceCandidate",value:function(e){e.candidate?this._sendSdp({type:"candidates",candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex}):s.default.debug("Empty candidate.")}},{key:"_onRemoteTrackAdded",value:function(e){s.default.debug("Remote track added.")}},{key:"_onRemoteStreamAdded",value:function(e){var t=this;s.default.debug("Remote stream added."),this._remoteStreamTracks.set(e.stream.id,[]);var n=[];e.stream.getTracks().forEach(function(i){n.push(i.id),t._remoteStreamTracks.get(e.stream.id).push(i.id)}),this._sendSignalingMessage(I,n);var i=new f.StreamSourceInfo(this._getAndDeleteTrackSourceInfo(e.stream.getAudioTracks()),this._getAndDeleteTrackSourceInfo(e.stream.getVideoTracks()));d.isSafari()&&(i.audio||e.stream.getAudioTracks().forEach(function(t){e.stream.removeTrack(t)}),i.video||e.stream.getVideoTracks().forEach(function(t){e.stream.removeTrack(t)}));var r=new f.RemoteStream(void 0,this._remoteId,e.stream,i);if(r){this._remoteStreams.push(r);var o=new f.StreamEvent("streamadded",{stream:r});this.dispatchEvent(o)}}},{key:"_onRemoteStreamRemoved",value:function(e){if(s.default.debug("Remote stream removed."),this._remoteStreamTracks.has(e.stream.id)){var t=[];this._remoteStreamTracks.get(e.stream.id).forEach(function(e){t.push(e)}),this._sendSignalingMessage(T,t),this._remoteStreamTracks.delete(e.stream.id);var n=this._remoteStreams.findIndex(function(t){return t.mediaStream.id===e.stream.id});if(-1!==n){var i=this._remoteStreams[n],r=new c.IcsEvent("ended");i.dispatchEvent(r),this._remoteStreams.splice(n,1)}}else s.default.warning("Cannot find stream info when it is being removed.")}},{key:"_onNegotiationneeded",value:function(){s.default.debug("On negotiation needed."),this._isCaller&&"stable"===this._pc.signalingState&&this._negotiationState===b.READY?this._doNegotiate():this._isCaller?this._isNegotiationNeeded=!0:this._sendSignalingMessage(C)}},{key:"_onRemoteIceCandidate",value:function(e){if(this._channelState===g.OFFERED||this._channelState===g.CONNECTING||this._channelState===g.CONNECTED){var t=new RTCIceCandidate({candidate:e.candidate,sdpMid:e.sdpMid,sdpMLineIndex:e.sdpMLineIndex});this._pc?(s.default.debug("Add remote ice candidates."),this._pc.addIceCandidate(t).catch(function(e){s.default.warning("Error processing ICE candidate: "+e)})):(s.default.debug("Cache remote ice candidates."),this._remoteIceCandidates.push(t))}}},{key:"_onSignalingStateChange",value:function(e){s.default.debug("Signaling state changed: "+this._pc.signalingState),"closed"===this._pc.signalingState||"stable"===this._pc.signalingState&&(this._negotiationState=b.READY,this._isCaller&&this._isNegotiationNeeded?this._doNegotiate():(this._drainPendingStreams(),this._drainPendingMessages()))}},{key:"_onIceConnectionStateChange",value:function(e){"closed"!==e.currentTarget.iceConnectionState&&"failed"!==e.currentTarget.iceConnectionState||(this._publishPromises.forEach(function(e){e.reject(new l.P2PError(l.errors.P2P_WEBRTC_UNKNOWN,"ICE connection failed or closed."))}),this._unpublishPromises.forEach(function(e){e.reject(new l.P2PError(l.errors.P2P_WEBRTC_UNKNOWN,"ICE connection failed or closed."))}),this._publishedStreams.forEach(function(e){e.dispatchEvent(new c.IcsEvent("ended"))}),this._publishedStreams.clear())}},{key:"_onDataChannelMessage",value:function(e){var t=JSON.parse(e.data);s.default.debug("Data channel message received: "+t.data),this._sendSignalingMessage(N,t.id);var n=new c.MessageEvent("messagereceived",{message:t.data,origin:this._remoteId});this.dispatchEvent(n)}},{key:"_onDataChannelOpen",value:function(e){s.default.debug("Data Channel is opened."),e.target.label===y&&(s.default.debug("Data channel for messages is opened."),this._drainPendingMessages())}},{key:"_onDataChannelClose",value:function(e){s.default.debug("Data Channel for "+peerId+" is closed.")}},{key:"_createPeerConnection",value:function(){var e=this;this._pc=new RTCPeerConnection(this._config.rtcConfiguration),"function"==typeof this._pc.addTransceiver&&(this._pc.addTransceiver("audio"),this._pc.addTransceiver("video")),this._pc.onaddstream=function(t){e._onRemoteStreamAdded.apply(e,[t])},this._pc.ontrack=function(t){e._onRemoteTrackAdded.apply(e,[t])},this._pc.onremovestream=function(t){e._onRemoteStreamRemoved.apply(e,[t])},this._pc.onnegotiationneeded=function(t){e._onNegotiationneeded.apply(e,[t])},this._pc.onicecandidate=function(t){e._onLocalIceCandidate.apply(e,[t])},this._pc.onsignalingstatechange=function(t){e._onSignalingStateChange.apply(e,[t])},this._pc.onicecandidate=function(t){e._onLocalIceCandidate.apply(e,[t])},this._pc.ondatachannel=function(t){s.default.debug("On data channel."),e._dataChannels.has(t.channel.label)||(e._dataChannels.set(t.channel.label,t.channel),s.default.debug("Save remote created data channel.")),e._bindEventsToDataChannel(t.channel)},this._drainPendingStreams(),this._drainPendingMessages()}},{key:"_drainPendingStreams",value:function(){if(s.default.debug("Draining pending streams."),this._pc&&"stable"===this._pc.signalingState){s.default.debug("Peer connection is ready for draining pending streams.");for(var e=0;e<this._pendingStreams.length;e++){var t=this._pendingStreams[e];this._pendingStreams.shift(),t.mediaStream&&(this._pc.addStream(t.mediaStream),s.default.debug("Added stream to peer connection."),this._sendStreamSourceInfo(t),s.default.debug("Sent stream source info."),this._publishedStreams.set(t))}this._pendingStreams.length=0;for(var n=0;n<this._pendingUnpublishStreams.length;n++)this._pendingUnpublishStreams[n].mediaStream&&(this._pc.removeStream(this._pendingUnpublishStreams[n].mediaStream),s.default.debug("Remove stream."));this._pendingUnpublishStreams.length=0}}},{key:"_drainPendingMessages",value:function(){if(s.default.debug("Draining pending messages."),0!=this._pendingMessages.length){var e=this._dataChannels.get(y);if(e&&"open"===e.readyState){for(var t=0;t<this._pendingMessages.length;t++)s.default.debug("Sending message via data channel: "+this._pendingMessages[t]),e.send(JSON.stringify(this._pendingMessages[t]));this._pendingMessages.length=0}else this._pc&&!e&&this._createDataChannel(y)}}},{key:"_sendStreamSourceInfo",value:function(e){var t=[];e.mediaStream.getTracks().map(function(n){t.push({id:n.id,source:e.source[n.kind]})}),this._sendSignalingMessage(O,t)}},{key:"_handleRemoteCapability",value:function(e){e.sdk&&e.sdk&&"JavaScript"===e.sdk.type&&e.runtime&&"Firefox"===e.runtime.name?(this._remoteSideSupportsRemoveStream=!1,this._remoteSideSupportsPlanB=!1,this._remoteSideSupportsUnifiedPlan=!0):(this._remoteSideSupportsRemoveStream=!0,this._remoteSideSupportsPlanB=!0,this._remoteSideSupportsUnifiedPlan=!1)}},{key:"_doNegotiate",value:function(){s.default.debug("Do negotiation."),this._negotiationState=b.NEGOTIATING,this._createAndSendOffer()}},{key:"_setCodecOrder",value:function(e){if(this._config.audioEncodings){var t=Array.from(this._config.audioEncodings,function(e){return e.codec.name});e=p.reorderCodecs(e,"audio",t)}if(this._config.videoEncodings){var n=Array.from(this._config.videoEncodings,function(e){return e.codec.name});e=p.reorderCodecs(e,"video",n)}return e}},{key:"_setRtpSenderOptions",value:function(e){return e}},{key:"_setRtpReceiverOptions",value:function(e){return e=this._setCodecOrder(e)}},{key:"_createAndSendOffer",value:function(){var e=this;this._pc?"stable"===this._pc.signalingState?(this._drainPendingStreams(),this._isNegotiationNeeded=!1,this._pc.createOffer(k).then(function(t){t.sdp=e._setRtpReceiverOptions(t.sdp),e._pc.setLocalDescription(t).then(function(){s.default.debug("Set local description successfully."),e._negotiationState=b.READY,e._sendSdp(t)},function(e){s.default.error("Set local description failed. Message: "+JSON.stringify(e))})},function(e){s.default.error("Create offer failed. Error info: "+JSON.stringify(e))})):this._negotiationState=b.NEGOTIATING:s.default.error("Peer connection have not been created.")}},{key:"_createAndSendAnswer",value:function(){var e=this;this._drainPendingStreams(),this._isNegotiationNeeded=!1,this._pc.createAnswer().then(function(t){t.sdp=e._setRtpReceiverOptions(t.sdp),e._pc.setLocalDescription(t).then(function(){s.default.debug("Set local description successfully."),e._sendSdp(t)},function(e){s.default.error("Error occurred while setting local description. Error message:"+e)})},function(e){s.default.error("Create answer failed. Message: "+e)})}},{key:"_getAndDeleteTrackSourceInfo",value:function(e){if(e.length>0){var t=e[0].id;if(this._remoteTrackSourceInfo.has(t)){var n=this._remoteTrackSourceInfo.get(t);return this._remoteTrackSourceInfo.delete(t),n}s.default.warning("Cannot find source info for "+t)}}},{key:"_unpublish",value:function(e){var t=this;return navigator.mozGetUserMedia||!this._remoteSideSupportsRemoveStream?(s.default.error("Unpublish is not supported on Firefox."),Promise.reject(new l.P2PError(l.errors.P2P_CLIENT_UNSUPPORTED_METHOD))):this._publishedStreams.has(e)?(this._pendingUnpublishStreams.push(e),new Promise(function(n,i){t._unpublishPromises.set(e.mediaStream.id,{resolve:n,reject:i}),t._drainPendingStreams()})):Promise.reject(new l.P2PError(l.errors.P2P_CLIENT_ILLEGAL_ARGUMENT))}},{key:"_createDataChannel",value:function(e){if(this._dataChannels.has(e))s.default.warning("Data channel labeled "+e+" already exists.");else if(this._pc){s.default.debug("Create data channel.");var t=this._pc.createDataChannel(e);this._bindEventsToDataChannel(t),this._dataChannels.set(y,t)}else s.default.debug("PeerConnection is not available before creating DataChannel.")}},{key:"_bindEventsToDataChannel",value:function(e){var t=this;e.onmessage=function(e){t._onDataChannelMessage.apply(t,[e])},e.onopen=function(e){t._onDataChannelOpen.apply(t,[e])},e.onclose=function(e){t._onDataChannelClose.apply(t,[e])},e.onerror=function(e){s.default.debug("Data Channel Error:",error)}}}]),t}();n.default=R},{"../base/event.js":3,"../base/logger.js":5,"../base/publication.js":8,"../base/sdputils.js":9,"../base/stream.js":10,"../base/utils.js":11,"./error.js":23}]},{},[22])(22)});